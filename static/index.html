<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Rust-local-LLMs</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ä¿æŒä½ ç°æœ‰çš„æ ·å¼ï¼Œä¸å˜ */
    body { font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 20px; background: #f4f7f6; color: #333; display: flex; flex-direction: column; align-items: center; }
    h1 { color: #007bff; margin-bottom: 30px; font-weight: 300; }
    #status { padding: 8px 15px; border-radius: 4px; margin-bottom: 20px; font-weight: bold; background-color: #fff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); width: 100%; max-width: 1200px; text-align: center; }
    .connected { color: #28a745; }
    .disconnected { color: #dc3545; }
    .warning { color: #ffc107; }
    #chat-container { display: flex; gap: 20px; width: 100%; max-width: 1200px; }
    #left-sidebar { flex: 0 0 320px; display: flex; flex-direction: column; gap: 20px; }
    #parameters { padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); height: fit-content; display: flex; flex-direction: column; }
    #parameters label { margin: 10px 0; font-weight: 500; font-size: 14px; }
    select, input[type="range"] { width: 100%; margin-top: 5px; }
    select { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; background-color: #fff; }
    .monitor-header { font-size: 32px; font-weight: 500; color: #6c757d; margin-bottom: 10px; padding: 0 20px; text-align: center;}
    #system-monitor { padding: 10px 0; background: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    .monitor-item { padding: 0 10px 10px 10px; }
    canvas { width: 100% !important; height: 80px !important; max-width: none; background: #ffffff; border: none; padding: 0; box-shadow: none; }
    .chat-main { flex-grow: 1; display: flex; flex-direction: column; }
    #chat-box { flex-grow: 1; border: none; padding: 15px; min-height: 550px; overflow-y: auto; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    #chat-box > div { margin-bottom: 15px; padding: 10px; border-radius: 12px; line-height: 1.5; max-width: 85%; }
    #chat-box > div:nth-child(odd) { background-color: #007bff; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
    #chat-box > div:nth-child(even) { background-color: #e9ecef; color: #333; margin-right: auto; border-bottom-left-radius: 4px; }
    #chat-box b { font-weight: bold; color: inherit; }
    #chat-box > div:nth-child(odd) b { color: white; }
    #chat-box > div:nth-child(even) b { color: #007bff; }
    #chat-box div[style*="color:red"] { background-color: #f8d7da !important; border: 1px solid #f5c6cb; color: #721c24 !important; margin: 10px auto; text-align: center; }
    #controls { display: flex; margin-top: 10px; width: 100%; gap: 8px; }
    #message-input { flex-grow: 1; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; }
    #message-input:focus { border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); outline: none; }
    #controls button { padding: 12px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 6px; transition: background-color 0.3s, transform 0.1s; font-size: 14px; }
    #controls button:hover { background-color: #0056b3; }
    #controls button:active { transform: scale(0.98); }
    @media (max-width: 768px) {
      #chat-container { flex-direction: column; }
      #left-sidebar { flex: 1 1 auto; width: 100%; }
      #system-monitor { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; }
      .monitor-item { padding: 0; }
      canvas { height: 100px !important; }
    }
  </style>
</head>
<body>
<h1>Rust-local-LLMs</h1>
<div id="status">è¿æ¥çŠ¶æ€: <span id="connection-status">æ£€æµ‹ä¸­...</span></div>

<div id="chat-container">

  <div id="left-sidebar">
    <div id="parameters">
      <label>é€‰æ‹©æ¨¡å‹:
        <select id="model-select">
          <option value="qwen3">qwen3</option>
          <option value="qwen3-candle">qwen3-candle</option>
        </select>
      </label>
      <button onclick="loadModel()">åŠ è½½æ¨¡å‹</button>

      <label>Temperature (<span id="temperature-value">0.7</span>):
        <input type="range" id="temperature-slider" min="0" max="1" step="0.05" value="0.7">
      </label>

      <label>Top-p (<span id="top-p-value">0.9</span>):
        <input type="range" id="top-p-slider" min="0" max="1" step="0.05" value="0.9">
      </label>
    </div>

    <div id="system-monitor">
      <div class="monitor-header">ç³»ç»Ÿç›‘æ§</div>
      <div class="monitor-item"><canvas id="cpu-chart" width="300" height="80"></canvas></div>
      <div class="monitor-item"><canvas id="mem-chart" width="300" height="80"></canvas></div>
      <div class="monitor-item"><canvas id="disk-chart" width="300" height="80"></canvas></div>
<!--      <div class="monitor-item"><canvas id="net-chart" width="300" height="80"></canvas></div>-->
    </div>
  </div>

  <div class="chat-main">
    <div id="chat-box"></div>
    <div id="controls">
      <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." />
      <button onclick="sendMessage()">å‘é€</button>
      <button onclick="resetConversation()">ğŸ†• æ–°å»ºå¯¹è¯</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const statusEl = document.getElementById("connection-status");
  const tempSlider = document.getElementById("temperature-slider");
  const tempVal = document.getElementById("temperature-value");
  const topPSlider = document.getElementById("top-p-slider");
  const topPVal = document.getElementById("top-p-value");
  const chatBox = document.getElementById("chat-box");
  const messageInput = document.getElementById("message-input");

  tempSlider.oninput = () => tempVal.textContent = tempSlider.value;
  topPSlider.oninput = () => topPVal.textContent = topPSlider.value;

  messageInput.addEventListener("keydown",(keycode)=>{
    if(keycode.key === "Enter")
      sendMessage();
  });

  async function checkServerHealth() {
    try {
      const resp = await fetch("/api/health");
      if (!resp.ok) {
        updateStatus("âŒ Rust æœåŠ¡å¼‚å¸¸", "disconnected");
        return;
      }

      const data = await resp.json();

      // --- çŠ¶æ€ç»„åˆåˆ¤æ–­ ---
      const llamaStatus = data.llama || "unknown";
      const candleStatus = data.candle || "unknown";

      if (data.status !== "ok") {
        updateStatus("âŒ Rust åç«¯å¼‚å¸¸", "disconnected");
        return;
      }

      // ä¼˜å…ˆåˆ¤æ–­ä¸¤ç§æ¨¡å‹éƒ½æ²¡åŠ è½½
      if (llamaStatus === "none" && candleStatus === "none") {
        updateStatus("âš ï¸ åç«¯æ­£å¸¸ï¼Œä½†æœªåŠ è½½ä»»ä½•æ¨¡å‹", "warning");
        return;
      }

      // åŒæ—¶æ£€æµ‹ llama ä¸ candle çŠ¶æ€
      if (llamaStatus === "llama_loaded" && candleStatus === "loaded") {
        updateStatus("âœ… Llama ä¸ Candle æ¨¡å‹å‡å·²åŠ è½½", "connected");
      } else if (llamaStatus === "llama_loaded") {
        updateStatus("âœ… Llama æœåŠ¡æ­£å¸¸", "connected");
      } else if (candleStatus === "candle_loaded") {
        updateStatus("âœ… Candle æ¨¡å‹å·²åŠ è½½", "connected");
      }else if (llamaStatus === "loading_or_error"){
        updateStatus("âœ… Llama æœåŠ¡æ­£åœ¨åŠ è½½", "loading");
      }else if (llamaStatus === "unreachable")
      {
        updateStatus("âŒ llamaæœåŠ¡ä¸å¯è¾¾", "error")
      }else {
        updateStatus("âš ï¸ æ¨¡å‹çŠ¶æ€æœªçŸ¥", "warning");
      }

    } catch (e) {
      console.error("å¥åº·æ£€æŸ¥å¤±è´¥:", e);
      updateStatus("âŒ æ— æ³•è¿æ¥ Rust æœåŠ¡", "disconnected");
    }
  }


  function updateStatus(msg, cls) {
    statusEl.textContent = msg;
    statusEl.className = cls;
  }

  async function sendMessage() {
    const msgInput = document.getElementById("message-input");
    const msg = msgInput.value.trim();
    if (!msg) return;
    msgInput.value = "";

    if (chatBox.childElementCount % 2 === 0)  //å‘é€æ¶ˆæ¯æ—¶ï¼Œæœ€æ–°æ¶ˆæ¯ä¸ºç”¨æˆ·æ–¹æ‰€åšçš„å¤„ç†
      chatBox.innerHTML += `<div style="color:blue"><i>------</i></div>`;

    const model = document.getElementById("model-select").value;
    const temperature = parseFloat(tempSlider.value);
    const top_p = parseFloat(topPSlider.value);

    chatBox.innerHTML += `<div><b>ä½ :</b> ${msg}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
      const resp = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg, model, temperature, top_p, reset: false })
      });
      const data = await resp.json();
      if (data.response) {
        chatBox.innerHTML += `<div><b>æ¨¡å‹:</b> ${data.response}</div>`;
      } else if (data.error) {
        chatBox.innerHTML += `<div style="color:red"><b>é”™è¯¯:</b> ${data.error}</div>`;
      }
    } catch (e) {
      chatBox.innerHTML += `<div style="color:red"><b>å¼‚å¸¸:</b> æ— æ³•è¿æ¥åˆ°èŠå¤©æœåŠ¡ã€‚</div>`;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function resetConversation() {
    if (chatBox.childElementCount % 2 === 1)
      chatBox.innerHTML += `<div style="color:blue"><i>--- æ–°å»ºå¯¹è¯ ---</i></div>`;
    else
      chatBox.innerHTML += `<div style="color:blue"><i>------------</i></div><div style="color:blue"><i>--- æ–°å»ºå¯¹è¯ ---</i></div>`;

    const model = document.getElementById("model-select").value;
    const temperature = parseFloat(tempSlider.value);
    const top_p = parseFloat(topPSlider.value);

    await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: "", model, temperature, top_p, reset: true })
    });
  }

  // ğŸ”¹ æ–°å¢ï¼šåŠ è½½å†å²è®°å½•
  async function loadHistory() {
    try {
      const resp = await fetch("/api/history");
      if (!resp.ok) return;
      const history = await resp.json();
      chatBox.innerHTML = ""; // æ¸…ç©ºæ—§å†…å®¹
      history.forEach(item => {
        if (item.role === "user") {
          chatBox.innerHTML += `<div><b>ä½ :</b> ${item.content}</div>`;
        } else {
          chatBox.innerHTML += `<div><b>æ¨¡å‹:</b> ${item.content}</div>`;
        }
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    } catch (e) {
      console.error("åŠ è½½å†å²å¤±è´¥", e);
    }
  }

  // ç³»ç»Ÿç›‘æ§
  const baseChartOptions = {
    animation: false,
    responsive: true,
    maintainAspectRatio: false,
    scales: { y: { min: 0, max: 100, title: { display: true, text: '%' }, ticks: { stepSize: 50 } }, x: { display: false } },
    plugins: { legend: { display: true, labels: { boxWidth: 10, padding: 5 } }, title: { display: false } },
    layout: { padding: { top: 5, bottom: 0, left: 0, right: 10 } }
  };
  const cpuChart = new Chart(document.getElementById("cpu-chart"), { type: "line", data: { labels: [], datasets: [{ label: "CPU %", data: [], borderColor: '#007bff', backgroundColor: 'rgba(0, 123, 255, 0.1)', tension: 0.3, fill: true, pointRadius: 0 }] }, options: baseChartOptions });
  const memChart = new Chart(document.getElementById("mem-chart"), { type: "line", data: { labels: [], datasets: [{ label: "å†…å­˜ %", data: [], borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.1)', tension: 0.3, fill: true, pointRadius: 0 }] }, options: baseChartOptions });
  const diskChart = new Chart(document.getElementById("disk-chart"), { type: "line", data: { labels: [], datasets: [{ label: "ç£ç›˜ %", data: [], borderColor: '#ffc107', backgroundColor: 'rgba(255, 193, 7, 0.1)', tension: 0.3, fill: true, pointRadius: 0 }] }, options: baseChartOptions });
  //const netChart = new Chart(document.getElementById("net-chart"), { type: "line", data: { labels: [], datasets: [{ label: "ç½‘ç»œ %", data: [], borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', tension: 0.3, fill: true, pointRadius: 0 }] }, options: baseChartOptions });

  async function updateSystemStats() {
    try {
      const resp = await fetch("/api/system_stats");
      if (!resp.ok) return;
      const data = await resp.json();
      const MAX_POINTS = 20;
      updateChart(cpuChart, data.cpu, MAX_POINTS);
      updateChart(memChart, data.memory, MAX_POINTS);
      updateChart(diskChart, data.disk, MAX_POINTS);
      //updateChart(netChart, data.network, MAX_POINTS);
    } catch (e) {
      console.error("ç³»ç»Ÿç›‘æ§å¤±è´¥", e);
    }
  }

  function updateChart(chart, arr, maxPoints) {
    let data = arr;
    if (arr.length > maxPoints) {
      data = arr.slice(-maxPoints);
    }
    chart.data.labels = data.map((_, i) => i);
    chart.data.datasets[0].data = data;
    chart.update();
  }

  async function loadModel() {
    const model = document.getElementById("model-select").value;
    try {
      const resp = await fetch("/api/load_model", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model })
      });
      const data = await resp.json();
      if (data.status === "ok") {
        alert("æ¨¡å‹åŠ è½½æˆåŠŸ: " + model);
      } else {
        alert("åŠ è½½å¤±è´¥: " + data.error);
      }
    } catch (e) {
      alert("âŒ è¯·æ±‚å¤±è´¥ï¼ŒRust åç«¯ä¸å¯ç”¨");
    }
  }

  // å¾ªç¯
  setInterval(checkServerHealth, 3000);
  setInterval(updateSystemStats, 3000);
  //åˆå§‹åŒ–åŠ è½½ä»»åŠ¡
  checkServerHealth();
  updateSystemStats();
  loadHistory();
</script>
</body>
</html>
